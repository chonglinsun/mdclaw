# mdclaw

**nanoclaw rebuilt as pure markdown skills.**

The host application is generated via Claude Code skill files. The repo ships real code for the container agent-runner (Claude Agent SDK + MCP tools + multi-turn support) and testing infrastructure. Clone the repo, run Claude Code, run `/setup`, and get a fully working nanoclaw-compatible personal AI assistant.

## Quick start

```bash
git clone https://github.com/youruser/mdclaw.git
cd mdclaw
claude
/setup
```

That's it. `/setup` handles everything:
- Builds the agent-runner (Claude Agent SDK integration)
- Generates all host source code (types, config, db, router, containers, scheduler, orchestrator)
- Asks which channels you want (WhatsApp, Telegram, or both)
- Installs dependencies
- Runs type checking and tests
- Configures `.env` and data directories
- Builds the Docker image
- Runs the full `/test` pre-flight check (15 checks)
- Verifies the complete system

You'll only be asked to act for things that genuinely require your input: choosing channels, entering a WhatsApp pairing code, or providing a Telegram bot token.

## What you get

After `/setup` completes:

- WhatsApp and/or Telegram integration
- Claude Agent SDK inside isolated Docker containers with MCP tools
- Multi-turn conversations (follow-up messages routed to active containers)
- Streaming output delivery (sentinel-marked blocks sent as they arrive)
- Structured I/O: containers use MCP tools to send messages, schedule tasks, register groups
- SQLite-backed message storage and routing
- Scheduled task automation (cron, interval, one-time)
- Per-group memory via `CLAUDE.md` files
- Global shared memory across all groups
- XML-formatted message context for agents
- Internal tag stripping (`<internal>...</internal>` removed from outbound)
- Env security: secrets never in `process.env`

## How it works

### Code split

| Component | Location | Type |
|-----------|----------|------|
| Agent-runner | `container/agent-runner/` | Real code (shipped) |
| Container image | `container/Dockerfile` | Real code (shipped) |
| Integration tests | `test/` | Real code (shipped) |
| Host application | `src/` | Generated by skills |
| Skill specs | `.claude/skills/` | Markdown (shipped) |
| Type contracts | `.claude/skills/add-core/types-contract.ts` | Anchor (shipped) |
| Schema contracts | `.claude/skills/add-core/schema.sql` | Anchor (shipped) |

### Container architecture

Containers receive a `ContainerInput` JSON on stdin with the prompt, session info, and secrets. Inside the container, the agent-runner:

1. Starts a Claude Agent SDK session
2. Registers MCP tools: `send_message`, `schedule_task`, `list_tasks`, `pause_task`, `resume_task`, `cancel_task`, `register_group`
3. Emits responses via sentinel markers for streaming delivery
4. Polls for follow-up messages (multi-turn conversations)
5. Archives transcripts on exit

### Skill layers

Each skill is a markdown file (`.claude/skills/*/SKILL.md`) that tells Claude Code exactly what code to generate. Two anchor files ensure cross-skill consistency:

- **`types-contract.ts`** — all TypeScript interfaces (copied verbatim into generated code)
- **`schema.sql`** — all database tables (used verbatim in the DB module)

TypeScript's type checker (`npx tsc --noEmit`) serves as the integration test — if it passes, the generated code is consistent.

## Advanced: layer skills

For users who want to generate code incrementally or customize individual layers:

| Order | Skill | What it generates |
|-------|-------|-------------------|
| 1 | `/init` | package.json, tsconfig.json, directory structure |
| 2 | `/add-core` | types, config, env validation, database, router, group-folder |
| 3 | `/add-containers` | Container lifecycle, runtime abstraction, IPC |
| 4 | `/add-scheduler` | Cron/interval task scheduler, group queue |
| 5 | `/add-orchestrator` | Main index.ts, XML message processor |
| 6 | `/add-whatsapp` | WhatsApp channel (Baileys v7, pairing code, LID) |
| 6 | `/add-telegram` | Telegram channel via Grammy (optional) |
| 7 | `/test` | 15-check pre-flight verification |

These are the same skills that `/setup` calls internally. Run them individually if you want to inspect or customize the output at each layer.

## Requirements

- Node.js 20+
- Docker (for container execution)
- Claude Code CLI
- A WhatsApp account and/or Telegram bot token

## Testing

```bash
# Run unit tests
npx vitest run

# Run integration test
npx vitest run test/integration.test.ts

# Run container smoke test
bash test/container-test.sh

# Run full pre-flight check
claude /test
```

## Philosophy

Inspired by nanoclaw's "skills over features" approach, mdclaw takes it to the logical extreme: the framework itself is a skill. The agent-runner is real code because it needs to work reliably inside containers. Everything else is generated from declarative specifications that Claude Code turns into a working system.

## License

MIT
