---
disable-model-invocation: true
---

# /add-containers — Container Runner and IPC

> **Note:** This skill is called automatically by `/setup`. You only need to run it individually if you want to generate the container modules separately for customization.

Generates the container lifecycle manager and file-based IPC system. The Dockerfile and agent-runner are shipped as real code in `container/` — this skill only generates the host-side modules.

## Prerequisites

These files must exist (generated by `/add-core`):

- `src/types.ts` — must export `ContainerConfig`, `ContainerResult`, `ContainerInput`, `IpcCommand`, `RegisteredGroup`
- `src/config.ts` — must export `config` with `CONTAINER_TIMEOUT`, `MAX_OUTPUT_SIZE`, `MAX_CONCURRENT_CONTAINERS`, `CONTAINER_RUNTIME`, `CONTAINER_IMAGE`
- `src/logger.ts` — must export `logger`
- `src/env.ts` — must export `env` with `ASSISTANT_NAME`
- `src/db.ts` — must export database functions
- `src/group-folder.ts` — must export `validateGroupFolder`

These files must exist as shipped real code:

- `container/Dockerfile` — container image definition
- `container/agent-runner/` — agent-runner package

## Context

This is Layer 2a — container execution and IPC. It provides the ability to run Claude agents in isolated Docker containers with structured JSON I/O, MCP tools, multi-turn support, and receive commands back via a file-based IPC protocol.

Read the **`ipc-protocol.md`** file in this skill's directory for the full IPC specification.

## Files to create

| File | Purpose |
|------|---------|
| `src/container.ts` | Container lifecycle: build, run, parse output, cleanup |
| `src/container-runtime.ts` | Container runtime abstraction (Docker, Apple Container) |
| `src/ipc.ts` | File-based IPC watcher and command dispatcher |
| `src/mount-security.ts` | Mount path validation and security |
| `src/container.test.ts` | Unit tests for container output parsing |
| `src/container-runtime.test.ts` | Unit tests for runtime detection |

## Interface contracts

Use these types from `src/types.ts` (already generated by /add-core):

```typescript
interface ContainerConfig {
  additionalMounts?: AdditionalMount[];
  timeout?: number;
}

interface ContainerResult {
  output: string;
  exitCode: number;
  timedOut: boolean;
}

interface ContainerInput {
  prompt: string;
  sessionId: string;
  groupFolder: string;
  chatJid: string;
  isMain: boolean;
  isScheduledTask: boolean;
  assistantName: string;
  secrets: Record<string, string>;
}

interface IpcCommand {
  type: 'schedule_task' | 'pause_task' | 'resume_task' | 'cancel_task' | 'refresh_groups' | 'register_group';
  payload: Record<string, unknown>;
  source_group: string;
}
```

## Behavioral requirements

### src/container-runtime.ts

1. Export `ContainerRuntime` interface:
   ```typescript
   interface ContainerRuntime {
     build(tag: string, dockerfilePath: string, contextDir: string): Promise<void>;
     run(args: string[], stdin?: string): Promise<{ stdout: string; stderr: string; exitCode: number }>;
     kill(containerId: string): Promise<void>;
     list(label: string): Promise<string[]>;
     cleanup(label: string): Promise<void>;
   }
   ```
2. Export `DockerRuntime` class implementing `ContainerRuntime`:
   - Uses `config.CONTAINER_RUNTIME` (default `'docker'`) as the binary
   - All methods spawn the runtime binary with appropriate arguments
3. Export `AppleContainerRuntime` class implementing `ContainerRuntime`:

   | Aspect | Docker | Apple Container |
   |--------|--------|-----------------|
   | Binary | `docker` | `container` |
   | Init | (daemon always running) | `container system start` if not running |
   | Build | `docker build -t tag -f Dockerfile .` | `container build -t tag -f Dockerfile .` |
   | Mount syntax | `-v /host:/container` | `--mount type=bind,src=/host,dst=/container` |
   | Env vars | `-e KEY=VALUE` works | `-e` buggy with `-i`; write secrets to temp file, mount it |
   | Detection | `docker --version` | `which container && container --version` |
   | Kill | `docker kill` | `container kill` |

   Key behavioral requirements:
   - `ensureSystemStarted()`: call `container system start` before build operations
   - `translateArgs()`: convert `-v` mounts to `--mount` syntax, collect `-e` vars into a temp secrets JSON file mounted read-only at `/secrets.json`
   - Agent-runner reads from `/secrets.json` if stdin secrets are empty
4. Export `detectRuntime()` function:
   - Returns `DockerRuntime` by default
   - Returns `AppleContainerRuntime` if `CONTAINER_RUNTIME === 'apple-container'`

### src/container.ts

1. Export `buildImage()` — builds the Docker image from `container/Dockerfile`:
   - Uses `docker build -t ${CONTAINER_IMAGE} -f container/Dockerfile .` (builds from project root with container/ Dockerfile)
2. Export `runContainer(groupFolder, input: ContainerInput, containerConfig?)` that:
   - Sends `ContainerInput` JSON on stdin (NOT plain text prompt)
   - Container naming: `mdclaw-${groupFolder}-${Date.now()}` with `--label mdclaw=true`
   - Constructs Docker run command with proper volume mounts
   - Mounts group-specific data directory as read-write at `/data`
   - Mounts IPC directory for the group at `/ipc`
   - Mounts `data/global/CLAUDE.md` read-only at `/data/global/CLAUDE.md` for non-main groups
   - Mounts per-group Claude settings: `data/sessions/${group}/.claude` at `/home/node/.claude`
   - Passes secrets via stdin as part of `ContainerInput` JSON
   - Parse sentinel markers in real-time (streaming) with `onOutput` callback
   - Reset idle timeout on each output marker detected
   - Sets container timeout from config or containerConfig override
   - Returns `ContainerResult`
3. Export `parseContainerOutput(raw: string)` that:
   - Extracts text between `---NANOCLAW_OUTPUT_START---` and `---NANOCLAW_OUTPUT_END---` sentinel markers
   - Returns empty string if markers not found
   - Handles multiple marker pairs (returns last one)
4. Export `parseAllOutputs(raw: string)` that:
   - Returns ALL sentinel-marked outputs as an array (for streaming delivery)
5. Export `killContainer(containerId: string)` — force stops a running container
6. Export `cleanupOrphans()` — kill leftover containers with `--label mdclaw=true` on startup
7. Enforce `MAX_CONCURRENT_CONTAINERS` limit — queue excess requests
8. Container runs as unprivileged `node` user (uid 1000)
9. Set `--network=none` by default for network isolation
10. Export `writePreRunData(ipcDir, groupFolder, tasks, groups?)`:
    - Write `current_tasks.json` with the group's scheduled tasks
    - Write `available_groups.json` with all registered groups (main group only)
11. Export `writeClaudeSettings(sessionsDir, groupFolder)`:
    - Write `data/sessions/${group}/.claude/settings.json` before each run
    - Content: allowed tools, auto-approve mode, CLAUDE.md globs

### Per-group Claude settings

Before each container run, write `data/sessions/${groupFolder}/.claude/settings.json`:

```json
{
  "permissions": {
    "allow": [
      "Bash(*)",
      "Read(*)",
      "Write(*)",
      "Edit(*)",
      "mcp__*"
    ],
    "deny": []
  },
  "settings": {
    "autoApprove": true
  }
}
```

### src/mount-security.ts

1. Export `validateMountPath(hostPath: string)` that:
   - Resolves symlinks before validation
   - Rejects paths containing blocked patterns: `.ssh`, `.gnupg`, `.aws`, `.docker`, `credentials`, `.env`, `.npmrc`, `id_rsa`
   - Rejects container paths with `..` or absolute paths outside allowed roots
   - Returns `{ valid: boolean; reason?: string }`
2. Export `getDefaultMounts(groupFolder: string, isMainGroup: boolean)` — returns standard mount configuration
3. Non-main groups get read-only mounts for project code

### src/ipc.ts

1. Export `createIpcWatcher(dataDir, handlers)` that:
   - Polls `${dataDir}/ipc/` directory every `IPC_POLL_INTERVAL` (1000ms)
   - Scans for JSON files in per-group subdirectories (`tasks/` and `messages/`)
   - Parses each file as `IpcCommand`
   - Validates source_group matches the directory path (prevents spoofing)
   - Validates group folder name via `validateGroupFolder()`
   - Dispatches to appropriate handler based on `type`
   - Deletes file after successful processing
   - Moves failed files to `errors/` subdirectory with error info appended
   - Returns `{ start(), stop() }` control object
2. Export `writeFollowUpMessage(dataDir, groupFolder, message)`:
   - Writes a follow-up message JSON file to `ipc/${groupFolder}/input/`
   - Used by orchestrator when message arrives for group with active container
3. Export `writeCloseSentinel(dataDir, groupFolder)`:
   - Writes `_close` file to `ipc/${groupFolder}/input/`
   - Signals container to finish multi-turn session
4. Export `IpcHandlers` interface:
   ```typescript
   interface IpcHandlers {
     onScheduleTask(cmd: IpcCommand): void;
     onPauseTask(cmd: IpcCommand): void;
     onResumeTask(cmd: IpcCommand): void;
     onCancelTask(cmd: IpcCommand): void;
     onRefreshGroups(cmd: IpcCommand): void;
     onRegisterGroup(cmd: IpcCommand): void;
   }
   ```
5. Authorization rules (see `ipc-protocol.md`):
   - `refresh_groups` and `register_group` — main group only
   - `schedule_task`, `pause_task`, `resume_task`, `cancel_task` — any group, but only for own tasks (non-main groups cannot modify other groups' tasks)
   - Unauthorized attempts are logged and the command file is rejected

### src/container.test.ts

1. Test `parseContainerOutput` with:
   - Output containing valid sentinel markers → extracts content
   - Output without markers → returns empty string
   - Output with multiple marker pairs → returns last one
   - Empty output → returns empty string
2. Test `parseAllOutputs`:
   - Multiple marker pairs → returns array of all outputs
3. Test `validateMountPath` with:
   - Normal path → valid
   - Path with `.ssh` → invalid
   - Path with `..` traversal → invalid

### src/container-runtime.test.ts

1. Test `detectRuntime()`:
   - Default → returns DockerRuntime instance
   - With `CONTAINER_RUNTIME=apple-container` → returns AppleContainerRuntime

## Integration points

| Export | Used by |
|--------|---------|
| `runContainer` | orchestrator (to execute agent prompts) |
| `parseContainerOutput` | orchestrator (to extract agent responses) |
| `parseAllOutputs` | orchestrator (for streaming delivery) |
| `buildImage` | setup skill (initial image build) |
| `cleanupOrphans` | orchestrator (on startup) |
| `createIpcWatcher` | orchestrator (to receive commands from containers) |
| `writeFollowUpMessage` | orchestrator (multi-turn message delivery) |
| `writeCloseSentinel` | orchestrator (signal container to finish) |
| `writePreRunData` | orchestrator (pre-container data preparation) |
| `writeClaudeSettings` | orchestrator (per-group container config) |
| `validateMountPath` | container (internal mount validation) |
| `ContainerRuntime` | container (runtime abstraction) |

## Verification

```bash
# Type check
npx tsc --noEmit

# Unit tests
npx vitest run src/container.test.ts src/container-runtime.test.ts

# Dockerfile exists in container/
ls container/Dockerfile container/build.sh
```
