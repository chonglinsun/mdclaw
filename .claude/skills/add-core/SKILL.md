---
disable-model-invocation: true
---

# /add-core — Foundation Layer

> **Note:** This skill is called automatically by `/setup`. You only need to run it individually if you want to generate the core modules separately for customization.

Generates the core modules: types, config, environment validation, database, router, and group folder validation.

## Prerequisites

These files must exist (generated by `/init`):

- `package.json`
- `tsconfig.json`
- `src/` directory

## Context

This is Layer 1 — the foundation that every subsequent skill depends on. It establishes the type system, configuration, database access, group routing, and input validation. The type and schema contracts are defined in anchor files that live alongside this SKILL.md:

- **`types-contract.ts`** — copy verbatim into `src/types.ts`
- **`schema.sql`** — use verbatim in the `initDb()` function in `src/db.ts`

## Files to create

| File | Purpose |
|------|---------|
| `src/types.ts` | All TypeScript interfaces (verbatim from `types-contract.ts`) |
| `src/config.ts` | Constants and configuration |
| `src/env.ts` | Environment variable loading and validation |
| `src/db.ts` | SQLite database initialization and query functions |
| `src/router.ts` | Group registration, message routing, state management |
| `src/logger.ts` | Pino logger setup |
| `src/group-folder.ts` | Group folder name validation |
| `src/db.test.ts` | Unit tests for db module |
| `src/group-folder.test.ts` | Unit tests for group folder validation |
| `src/env.test.ts` | Unit tests for env security |

## Interface contracts

Copy the contents of `types-contract.ts` (in this skill's directory) verbatim into `src/types.ts`. Add a file header comment `// Generated by mdclaw /add-core` and ensure all types are exported.

## Behavioral requirements

### src/config.ts

1. Export a `config` object with all constants from the CLAUDE.md constants table
2. Export paths: `STORE_DIR`, `DATA_DIR`, `AUTH_DIR`, `IPC_DIR`
3. All paths derived from environment variables with sensible defaults
4. Container output sentinel markers: `---NANOCLAW_OUTPUT_START---` and `---NANOCLAW_OUTPUT_END---`
5. Add `CONTAINER_IMAGE` from `env.CONTAINER_IMAGE` (default: `'mdclaw'`)

### src/env.ts

1. **Custom selective `.env` parser** — do NOT use `dotenv.config()` which pollutes `process.env`
2. Read `.env` file manually, parse key-value lines, store in a validated `env` object only
3. Never load environment variables into `process.env` — keep them isolated in the `env` export
4. Define a Zod schema for all required and optional environment variables
5. Export a validated `env` object
6. Required: `STORE_DIR`, `DATA_DIR`, `MAIN_GROUP_FOLDER`
7. Optional with defaults:
   - `LOG_LEVEL` (default: `'info'`)
   - `CONTAINER_RUNTIME` (default: `'docker'`)
   - `CONTAINER_IMAGE` (default: `'mdclaw'`)
   - `ASSISTANT_NAME` (default: `'Andy'`)
   - `TELEGRAM_BOT_TOKEN`
   - `TELEGRAM_ONLY` (default: `'false'`)
   - `TZ` (timezone, optional)
8. Throw a clear error on validation failure listing all missing/invalid vars
9. Secrets (`ANTHROPIC_API_KEY`, etc.) are read from `.env` but stored ONLY in the `env` object, never in `process.env`

### src/logger.ts

1. Create and export a pino logger instance
2. Log level from `env.LOG_LEVEL`
3. Use `pino-pretty` transport in development (when `NODE_ENV !== 'production'`)

### src/group-folder.ts

1. Export `validateGroupFolder(folder: string): { valid: boolean; reason?: string }`
2. Pattern: `^[A-Za-z0-9][A-Za-z0-9_-]{0,63}$`
3. Reserved names: `"global"` (used for shared data), `"errors"` (used by IPC)
4. Called in IPC handler and router to validate group folder names

### src/db.ts

1. Export `initDb(dbPath?: string)` that:
   - Creates/opens SQLite database at `dbPath` (default: `${STORE_DIR}/messages.db`)
   - Runs all CREATE TABLE statements from `schema.sql` verbatim (including the `jid` column on `registered_groups`)
   - Enables WAL mode for concurrent reads
   - Returns the `Database` instance
2. Export query functions (all synchronous, using `better-sqlite3`):
   - `storeChatMetadata(db, jid, timestamp, name?, channel?, isGroup?)` — upsert into chats
   - `updateChatName(db, jid, name)` — update chat name
   - `getAllChats(db)` — return all chats ordered by last_activity desc
   - `storeMessage(db, message: NewMessage)` — insert message, ignore duplicates
   - `getNewMessages(db, chatJid, since)` — messages after timestamp, exclude bot messages
   - `getMessagesSince(db, chatJid, since)` — all messages after timestamp
   - `getRouterState(db, key)` / `setRouterState(db, key, value)` — key-value state
   - `getSession(db, groupFolder)` / `setSession(db, groupFolder, sessionId)` — session mapping
   - `getRegisteredGroups(db)` — return all registered groups as `RegisteredGroup[]`
   - `registerGroup(db, group: RegisteredGroup)` — upsert group registration (including `jid` column)
   - `removeGroup(db, folder)` — delete group registration
3. All query functions take `db: Database` as first parameter (dependency injection, not global)

### src/router.ts

1. Export `createRouter(db: Database)` that returns a router object with:
   - `loadState()` — load registered groups and last-processed timestamps from DB
   - `getRegisteredGroups()` — return current registered groups
   - `registerGroup(group)` — validate folder name via `validateGroupFolder()`, register a group and persist to DB
   - `removeGroup(folder)` — remove a group and persist to DB
   - `getLastProcessed(jid)` / `setLastProcessed(jid, timestamp)` — message cursor tracking
   - `findGroupByJid(jid)` — look up registered group by chat JID
   - `getChatJid(folder)` / `setChatJid(folder, jid)` — map group → chat (using `jid` column)
   - `isMainGroup(folder)` — check if folder matches MAIN_GROUP_FOLDER
2. Router holds state in memory, syncs to DB on mutations
3. The router does NOT import any channel modules — it's channel-agnostic

### src/db.test.ts

1. Creates an in-memory SQLite database
2. Tests storeMessage / getNewMessages round-trip
3. Tests registerGroup / getRegisteredGroups round-trip (including `jid` field)
4. Tests getRouterState / setRouterState round-trip

### src/group-folder.test.ts

1. Valid patterns: `"main"`, `"weather-bot"`, `"Group_123"`
2. Invalid patterns: `""`, `"-start"`, `"has spaces"`, `"../traversal"`, `"a".repeat(65)`
3. Reserved names: `"global"`, `"errors"` → rejected

### src/env.test.ts

1. Test that secrets are NOT in `process.env` after loading
2. Test that the `env` object contains parsed values
3. Test validation failure for missing required vars

## Integration points

| Export | Used by |
|--------|---------|
| All types from `src/types.ts` | Every other module |
| `config` from `src/config.ts` | container, scheduler, orchestrator |
| `env` from `src/env.ts` | config, db, channels |
| `logger` from `src/logger.ts` | Every other module |
| `initDb` + query functions from `src/db.ts` | router, scheduler, orchestrator |
| `createRouter` from `src/router.ts` | orchestrator |
| `validateGroupFolder` from `src/group-folder.ts` | router, ipc |

## Verification

```bash
# Install dependencies first
npm install

# Type check — must pass with zero errors
npx tsc --noEmit

# Unit tests
npx vitest run src/db.test.ts src/group-folder.test.ts src/env.test.ts
```
